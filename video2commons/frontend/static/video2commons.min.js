!function(e){"use strict";var t=window.i18n,n='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',a="rtl"===t["@dir"],s={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+Mustache.escape(t.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-trash"></span> '+Mustache.escape(t.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-warning btn-xs flip pull-right"><span class="glyphicon glyphicon-repeat"></span> '+Mustache.escape(t.restart)+"</button>",loading:"<center>"+n+"&nbsp;&nbsp;"+Mustache.escape(t.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+Mustache.escape(t.errorDisconnect)+"</div>",yourTasks:"<h4>"+Mustache.escape(t.yourTasks)+'</h4><table id="tasktable" class="table"><tbody></tbody></table>',addTask:'<input class="btn btn-primary btn-success btn-md" type="button" accesskey="n" value="'+Mustache.escape(t.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+Mustache.escape(t.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(a?"right":"left")+'"></span> '+Mustache.escape(t.back),nextbutton:Mustache.escape(t.next)+' <span class="glyphicon glyphicon-chevron-'+(a?"left":"right")+'"></span>',confirmbutton:Mustache.escape(t.confirm)+' <span class="glyphicon glyphicon-ok"></span>'},i="";t.a=function(){return function(e,t){if("#"===e[0]){var n=e.indexOf("|");if(n<0){if(/^[a-z0-9\-]+$/i.test(e.slice(1)))return'<a id="'+e.slice(1)+'"></a>'}else if(/^[a-z0-9\-]+$/i.test(e.substring(1,n)))return'<a id="'+e.substring(1,n)+'">'+t(e.slice(n+1))+"</a>"}return"<a>"+t(e)+"</a>"}};var r,o,d=window.video2commons={init:function(){e("#content").html(s.loading),d.loadCsrf(),d.checkStatus()},loadCsrf:function(){e.get("api/csrf").done(function(e){i=e.csrf})},checkStatus:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);var t="api/status";e.get(t).done(function(t){e("#tasktable").length||d.setupTables(),d.populateResults(t),window.lastStatusCheck=setTimeout(d.checkStatus,t.hasrunning?5e3:6e4)}).fail(function(){e("#content").html(s.errorDisconnect)})},setupTables:function(){e("#content").html(s.yourTasks);var t=e(s.addTask);e("#content").append(t),t.click(function(){d.addTask()});var n=e(s.requestServerSide);e("#content").append(n.hide())},populateResults:function(n){var a=window.innerHeight+window.scrollY>=document.body.offsetHeight,i=e("#tasktable > tbody");e("#task-new").remove(),i.find("> tr").each(function(){var t=e(this),a=d.getTaskIDFromDOMID(t.attr("id"));n.ids.indexOf(a)<0&&t.remove()}),e.each(n.values,function(n,a){var r="task-"+a.id,o=e("#"+r),c=!1;if(o.length?o.attr("status")!==a.status&&(o.html(""),c=!0):(o=e("<tr />"),o.attr({id:r,status:a.status}),i.append(o),c=!0),c){switch(a.status){case"progress":o.append(e("<td />").attr("id",r+"-title").attr("width","30%")).append(e("<td />").attr("id",r+"-status").attr("width","40%").append(e("<span />").attr("id",r+"-statustext"))).append(e("<td />").attr("id",r+"-progress").attr("width","30%"));var l=d.eventButton(r,"abort");o.find("#"+r+"-status").append(l);var u=o.find("#"+r+"-progress").html(s.progressbar);d.setProgressBar(u,-1),o.removeClass("success danger");break;case"done":d.appendButtons([d.eventButton(r,"remove")],o,["danger","success"],r);break;case"fail":var f=d.eventButton(r,"remove"),p=d.eventButton(r,"restart").hide();d.appendButtons([f,p],o,["success","danger"],r);break;case"needssu":d.appendButtons([d.eventButton(r,"remove")],o,["success","danger"],r);break;case"abort":d.appendButtons([],o,["success","danger"],r)}o.attr("status",a.status)}o.find("#"+r+"-title").text(a.title);var h=function(e,t,n){var a=o.find("#"+r+"-statustext");if(t){var s=a.html(e).find("a").attr("href",t);n&&s.text(n)}else a.text(e)};"done"===a.status?h(Mustache.render("{{> taskDone}}",t,t),a.url,a.text):"needssu"===a.status?h(Mustache.render("{{> errorTooLarge}}",t,t),a.url):"fail"===a.status?(h(a.text),a.restartable?o.find("#"+r+"-restartbutton").show().off().click(function(){d.eventTask(this,"restart")}):o.find("#"+r+"-restartbutton").off().hide()):h(a.text),"progress"===a.status&&d.setProgressBar(o.find("#"+r+"-progress"),a.progress)}),n.ssulink?e("#ssubtn").removeClass("disabled").show().attr("href",n.ssulink):e("#ssubtn").addClass("disabled").hide(),a&&window.scrollTo(0,document.body.scrollHeight)},setProgressBar:function(e,t){var n=e.find(".progress-bar");t<0?(n.addClass("progress-bar-striped active").addClass("active").text(""),t=100):n.removeClass("progress-bar-striped active").text(Math.round(t)+"%"),n.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},getTaskIDFromDOMID:function(e){var t=/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(e);return t[1]},eventTask:function(t,n){t=e(t),t.is(".disabled")||(t.off().addClass("disabled"),d.apiPost("task/"+n,{id:d.getTaskIDFromDOMID(t.attr("id"))}).done(function(e){e.error&&window.alert(e.error),d.checkStatus()}))},setText:function(e,t){for(var n=0;n<e.length;n++)r.find("#"+e[n]).text(t[e[n]])},eventButton:function(t,n){return e(s[n+"button"]).attr("id",t+"-"+n+"button").off().click(function(){d.eventTask(this,n)})},appendButtons:function(t,n,a,s){n.append(e("<td />").attr("id",s+"-title").attr("width","30%"));var i=e("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(e("<span />").attr("id",s+"-statustext"));t.length&&i.append(t[0]);for(var r=1;r<t.length;r++)i.append(t[r]);n.append(i).removeClass(a[0]).addClass(a[1])},addTask:function(){r?d.openTaskModal():e.get("static/html/addTask.min.html").success(function(n){r=e("<div>").html(Mustache.render(n,t)),r.addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),e("body").append(r),r.find("#btn-prev").html(s.prevbutton),r.find("#btn-next").html(s.nextbutton),r.find("#btn-cancel").click(function(){window.jqXHR&&window.jqXHR.abort()}),r.find(".modal-body").keypress(function(t){13!==(t.which||t.keyCode)||e(":focus").is("textarea")||(r.find(".modal-footer #btn-next").click(),t.preventDefault())}),d.openTaskModal()})},openTaskModal:function(){r.find("#dialog-spinner").hide(),r.find(".modal-body").html("<center>"+n+"</center>"),d.newTask(),r.modal(),r.on("shown.bs.modal",function(){r.find("#url").focus()}),d.reactivatePrevNextButtons()},newTask:function(){o={step:"source",url:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,formats:[],format:"",filedesc:"",uploadedFile:{},filenamechecked:!1,filedescchecked:!1},d.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(o.step){case"source":e.get("static/html/sourceForm.min.html").success(function(e){e=Mustache.render(e,t,t),r.find(".modal-body").html(e),r.find("a#vc").attr("href","//tools.wmflabs.org/videoconvert/"),r.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),r.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),r.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),r.find("#url").val(o.url).focus(),r.find("#video").prop("checked",o.video),r.find("#audio").prop("checked",o.audio),r.find("#subtitles").prop("checked",o.subtitles),d.initUpload()});break;case"target":e.get("static/html/targetForm.min.html").success(function(n){n=Mustache.render(n,t),r.find(".modal-body").html(n),r.find("#filename").val(o.filename).focus(),e.each(o.formats,function(t,n){r.find("#format").append(e("<option></option>").text(n))}),r.find("#format").val(o.format),r.find("#filedesc").val(o.filedesc)});break;case"confirm":e.get("static/html/confirmForm.min.html").success(function(e){e=Mustache.render(e,t),r.find(".modal-body").html(e);var n=[];o.video&&n.push(t.video),o.audio&&n.push(t.audio),o.subtitles&&n.push(t.subtitles),r.find("#keep").text(n.join(", ")),d.setText(["url","extractor","filename","format"],o),r.find("#filedesc").val(o.filedesc),r.find("#btn-next").focus()})}},reactivatePrevNextButtons:function(){switch(r.find("#dialog-spinner").hide(),o.step){case"source":r.find("#btn-prev").addClass("disabled").off(),r.find("#btn-next").html(s.nextbutton),d.setPrevNextButton("next");break;case"target":d.setPrevNextButton("prev"),r.find("#btn-next").html(s.nextbutton),d.setPrevNextButton("next");break;case"confirm":d.setPrevNextButton("prev"),r.find("#btn-next").removeClass("disabled").html(s.confirmbutton).off().click(function(){d.disablePrevNext(!1),r.modal("hide"),e("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+n+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),d.apiPost("task/run",o).done(function(e){e.error&&window.alert(e.error),d.checkStatus()})})}},setPrevNextButton:function(e){r.find("#btn-"+e).removeClass("disabled").off().click(function(){d.processInput(e)})},disablePrevNext:function(e){r.find(".modal-body #dialog-errorbox").hide(),r.find("#btn-prev").addClass("disabled").off(),r.find("#btn-next").addClass("disabled").off(),e&&r.find("#dialog-spinner").show()},processInput:function(t){var n,a=e.when();switch(o.step){case"source":n=e.when(function(){var e=r.find("#video").is(":checked"),t=r.find("#audio").is(":checked");return o.subtitles=r.find("#subtitles").is(":checked"),o.formats.length&&e===o.video&&t===o.audio?a:d.askAPI("listformats",{video:e,audio:t},["video","audio","format","formats"])}(),function(){var t=r.find("#url").val();if(!t)return e.Deferred().reject("URL cannot be empty!").promise();if(t!==o.url){o.filenamechecked=!1,o.filedescchecked=!1;var n=o.uploadedFile[t];return n?(o.url=t,d.askAPI("makedesc",{filename:n.name||""},["extractor","filedesc","filename"])):d.askAPI("extracturl",{url:t},["url","extractor","filedesc","filename"])}return a}());break;case"target":n=e.when(function(){var t=r.find("#filename").val();return o.format=r.find("#format").val(),t?o.filenamechecked&&t===o.filename?a:d.askAPI("validatefilename",{filename:t},["filename"]).done(function(){o.filenamechecked=!0}):e.Deferred().reject("Filename cannot be empty!").promise()}(),function(){var t=r.find("#filedesc").val();return t?o.filedescchecked&&t===o.filedesc?a:d.askAPI("validatefiledesc",{filedesc:t},["filedesc"]).done(function(){o.filedescchecked=!0}):e.Deferred().reject("File description cannot be empty!").promise()}());break;case"confirm":n=a}d.promiseWorkingOn(n.done(function(){var e={prev:-1,next:1}[t],n=["source","target","confirm"];o.step=n[n.indexOf(o.step)+e],d.setupAddTaskDialog()}))},promiseWorkingOn:function(t){return d.disablePrevNext(!0),t.fail(function(t){r.find(".modal-body #dialog-errorbox").length||r.find(".modal-body").append(e('<div class="alert alert-danger" id="dialog-errorbox"></div>')),r.find(".modal-body #dialog-errorbox").text("Error: "+t).show()}).always(d.reactivatePrevNextButtons)},initUpload:function(){var t;window.jqXHR=r.find("#fileupload").fileupload({dataType:"json",formData:{_csrf_token:i},maxChunkSize:4<<20,sequentialUploads:!0}).on("fileuploadadd",function(n,a){window.jqXHR=a.submit(),t=e.Deferred(),d.promiseWorkingOn(t.promise()),r.find("#src-url").hide(),r.find("#src-uploading").show(),r.find("#upload-abort").off().click(function(){window.jqXHR&&window.jqXHR.abort(),t.reject("Upload aborted.")})}).on("fileuploadchunkdone",function(e,n){n.formData.filekey&&(n.formData.filekey=n.result.filekey),"Continue"===n.result.result&&n.result.offset!==n.uploadedBytes&&(n.uploadedBytes=n.result.offset),n.result.error&&(window.jqXHR&&window.jqXHR.abort(),t.reject(n.result.error))}).on("fileuploadprogressall",function(e,t){d.setProgressBar(r.find("#upload-progress"),t.loaded/t.total*100)}).on("fileuploadalways",function(){d.reactivatePrevNextButtons(),r.find("#src-url").show(),r.find("#src-uploading").hide()}).on("fileuploadfail",function(){t.reject("Something went wrong while uploading... try again?")}).on("fileuploaddone",function(e,n){var a="uploads:"+n.result.filekey;o.uploadedFile[a]=n.files[0],r.find("#url").val(a),t.resolve()})},askAPI:function(t,n,a){var s=e.Deferred();return d.apiPost(t,n).done(function(e){if(e.error)return void s.reject(e.error);for(var t=0;t<a.length;t++)o[a[t]]=e[a[t]];s.resolve(e)}).fail(function(){s.reject("Something weird happened. Please try again.")}),s.promise()},apiPost:function(t,n){return n._csrf_token=i,e.post("api/"+t,n)}};e(document).ready(function(){d.init()})}(jQuery);