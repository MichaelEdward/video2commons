!function(a){"use strict";var t=window.i18n,e='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',n="rtl"===t["@dir"],s={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+Mustache.escape(t.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-trash"></span> '+Mustache.escape(t.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-warning btn-xs flip pull-right"><span class="glyphicon glyphicon-repeat"></span> '+Mustache.escape(t.restart)+"</button>",loading:"<center>"+e+"&nbsp;&nbsp;"+Mustache.escape(t.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+Mustache.escape(t.errorDisconnect)+"</div>",yourTasks:"<h4>"+Mustache.escape(t.yourTasks)+'</h4><table id="tasktable" class="table"><tbody></tbody></table>',addTask:'<input class="btn btn-primary btn-success btn-md" type="button" accesskey="n" value="'+Mustache.escape(t.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+Mustache.escape(t.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(n?"right":"left")+'"></span> '+Mustache.escape(t.back),nextbutton:Mustache.escape(t.next)+' <span class="glyphicon glyphicon-chevron-'+(n?"left":"right")+'"></span>',confirmbutton:Mustache.escape(t.confirm)+' <span class="glyphicon glyphicon-ok"></span>'},i="";t.a=function(){return function(a,t){if("#"===a[0]){var e=a.indexOf("|");if(0>e){if(/^[a-z0-9\-]+$/i.test(a.slice(1)))return'<a id="'+a.slice(1)+'"></a>'}else if(/^[a-z0-9\-]+$/i.test(a.substring(1,e)))return'<a id="'+a.substring(1,e)+'">'+t(a.slice(e+1))+"</a>"}return"<a>"+t(a)+"</a>"}};var o=window.video2commons={init:function(){a("#content").html(s.loading),o.loadCsrf(),o.checkStatus()},loadCsrf:function(){a.get("api/csrf").done(function(a){i=a.csrf})},checkStatus:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);var t="api/status";a.get(t).done(function(t){a("#tasktable").length||o.setupTables(),o.populateResults(t),window.lastStatusCheck=setTimeout(o.checkStatus,t.hasrunning?5e3:6e4)}).fail(function(){a("#content").html(s.errorDisconnect)})},setupTables:function(){a("#content").html(s.yourTasks);var t=a(s.addTask);a("#content").append(t),t.click(function(){o.addTask()});var e=a(s.requestServerSide);a("#content").append(e.hide())},setProgressBar:function(a,t){var e=a.find(".progress-bar");0>t?(e.addClass("progress-bar-striped active").addClass("active").text(""),t=100):e.removeClass("progress-bar-striped active").text(t+"%"),e.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},getTaskIDFromDOMID:function(a){var t=/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(a);return t[1]},populateResults:function(e){var n=window.innerHeight+window.scrollY>=document.body.offsetHeight,i=a("#tasktable > tbody");a("#task-new").remove(),i.find("> tr").each(function(){var t=a(this),n=o.getTaskIDFromDOMID(t.attr("id"));e.ids.indexOf(n)<0&&t.remove()}),a.each(e.values,function(e,n){var d="task-"+n.id,r=a("#"+d),l=!1;if(r.length?r.attr("status")!==n.status&&(r.html(""),l=!0):(r=a("<tr />"),r.attr({id:d,status:n.status}),i.append(r),l=!0),l){switch(n.status){case"progress":r.append(a("<td />").attr("id",d+"-title").attr("width","30%")).append(a("<td />").attr("id",d+"-status").attr("width","40%").append(a("<span />").attr("id",d+"-statustext"))).append(a("<td />").attr("id",d+"-progress").attr("width","30%"));var c=o.eventButton(d,"abort");r.find("#"+d+"-status").append(c);var w=r.find("#"+d+"-progress").html(s.progressbar);o.setProgressBar(w,-1),r.removeClass("success danger");break;case"done":o.appendButtons([o.eventButton(d,"remove")],r,["danger","success"],d);break;case"fail":var u=o.eventButton(d,"remove"),f=o.eventButton(d,"restart").hide();o.appendButtons([u,f],r,["success","danger"],d);break;case"needssu":o.appendButtons([o.eventButton(d,"remove")],r,["success","danger"],d);break;case"abort":o.appendButtons([],r,["success","danger"],d)}r.attr("status",n.status)}r.find("#"+d+"-title").text(n.title);var p=function(a,t,e){var n=r.find("#"+d+"-statustext");if(t){var s=n.html(a).find("a").attr("href",t);e&&s.text(e)}else n.text(a)};"done"===n.status?p(Mustache.render("{{> taskDone}}",t,t),n.url,n.text):"needssu"===n.status?p(Mustache.render("{{> errorTooLarge}}",t,t),n.url):"fail"===n.status?(p(n.text),n.restartable?r.find("#"+d+"-restartbutton").show().off().click(function(){o.eventTask(this,"restart")}):r.find("#"+d+"-restartbutton").off().hide()):p(n.text),"progress"===n.status&&o.setProgressBar(r.find("#"+d+"-progress"),n.progress)}),e.ssulink?a("#ssubtn").removeClass("disabled").show().attr("href",e.ssulink):a("#ssubtn").addClass("disabled").hide(),n&&window.scrollTo(0,document.body.scrollHeight)},addTask:function(){window.addTaskDialog?o.openTaskModal():a.get("static/html/addTask.min.html").success(function(e){window.addTaskDialog=a("<div>").html(Mustache.render(e,t)),window.addTaskDialog.addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),a("body").append(window.addTaskDialog),window.addTaskDialog.find("#btn-prev").html(s.prevbutton),window.addTaskDialog.find("#btn-next").html(s.nextbutton),window.addTaskDialog.find(".modal-body").keypress(function(t){13!==(t.which||t.keyCode)||a(":focus").is("textarea")||(window.addTaskDialog.find(".modal-footer #btn-next").click(),t.preventDefault())}),o.openTaskModal()})},newTask:function(){window.newTaskData={step:"source",url:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,filenamechecked:!1,formats:[],format:"",filedesc:""},o.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(window.newTaskData.step){case"source":a.get("static/html/sourceForm.min.html").success(function(a){a=Mustache.render(a,t,t),window.addTaskDialog.find(".modal-body").html(a),window.addTaskDialog.find("a#vc").attr("href","//tools.wmflabs.org/videoconvert/"),window.addTaskDialog.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),window.addTaskDialog.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),window.addTaskDialog.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),window.addTaskDialog.find("#url").val(window.newTaskData.url).focus(),window.addTaskDialog.find("#video").prop("checked",window.newTaskData.video),window.addTaskDialog.find("#audio").prop("checked",window.newTaskData.audio),window.addTaskDialog.find("#subtitles").prop("checked",window.newTaskData.subtitles)});break;case"target":a.get("static/html/targetForm.min.html").success(function(e){e=Mustache.render(e,t),window.addTaskDialog.find(".modal-body").html(e),window.addTaskDialog.find("#filename").val(window.newTaskData.filename).focus(),a.each(window.newTaskData.formats,function(t,e){window.addTaskDialog.find("#format").append(a("<option></option>").text(e))}),window.addTaskDialog.find("#format").val(window.newTaskData.format),window.addTaskDialog.find("#filedesc").val(window.newTaskData.filedesc)});break;case"confirm":a.get("static/html/confirmForm.min.html").success(function(a){a=Mustache.render(a,t),window.addTaskDialog.find(".modal-body").html(a);var e=[];window.newTaskData.video&&e.push(t.video),window.newTaskData.audio&&e.push(t.audio),window.newTaskData.subtitles&&e.push(t.subtitles),window.addTaskDialog.find("#keep").text(e.join(", ")),o.setText(["url","extractor","filename","format"],window.newTaskData),window.addTaskDialog.find("#filedesc").val(window.newTaskData.filedesc),window.addTaskDialog.find("#btn-next").focus()})}o.reactivatePrevNextButtons()},showFormError:function(t){window.addTaskDialog.find(".modal-body #dialog-errorbox").length||window.addTaskDialog.find(".modal-body").append(a('<div class="alert alert-danger" id="dialog-errorbox"></div>')),window.addTaskDialog.find(".modal-body #dialog-errorbox").text("Error: "+t).show(),o.reactivatePrevNextButtons()},reactivatePrevNextButtons:function(){switch(window.addTaskDialog.find("#dialog-spinner").hide(),window.newTaskData.step){case"source":window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").html(s.nextbutton),o.setPrevNextButton("next");break;case"target":o.setPrevNextButton("prev"),window.addTaskDialog.find("#btn-next").html(s.nextbutton),o.setPrevNextButton("next");break;case"confirm":o.setPrevNextButton("prev"),window.addTaskDialog.find("#btn-next").removeClass("disabled").html(s.confirmbutton).off().click(function(){o.disablePrevNext(!1),window.addTaskDialog.modal("hide"),a("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+e+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),o.apiPost("task/run",window.newTaskData).done(function(a){a.error&&window.alert(a.error),o.checkStatus()})})}},setPrevNextButton:function(a){window.addTaskDialog.find("#btn-"+a).removeClass("disabled").off().click(function(){o.disablePrevNext(!0),o.processInput(a)})},disablePrevNext:function(a){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off(),a&&window.addTaskDialog.find("#dialog-spinner").show()},processInput:function(a){var t=function(){var t={prev:-1,next:1}[a],e=["source","target","confirm"];window.newTaskData.step=e[e.indexOf(window.newTaskData.step)+t],o.setupAddTaskDialog()};switch(window.newTaskData.step){case"source":var e=window.addTaskDialog.find("#url").val(),n=window.addTaskDialog.find("#video").is(":checked"),s=window.addTaskDialog.find("#audio").is(":checked");if(window.newTaskData.subtitles=window.addTaskDialog.find("#subtitles").is(":checked"),!e)return void o.showFormError("URL cannot be empty!");var i=function(){window.newTaskData.formats.length&&n===window.newTaskData.video&&s===window.newTaskData.audio?t():o.askAPI("listformats",{video:n,audio:s},["video","audio","format","formats"],t)},d=function(){e!==window.newTaskData.url?(window.newTaskData.filenamechecked=!1,o.askAPI("extracturl",{url:e},["url","extractor","filedesc","filename"],i)):i()};d();break;case"target":var r=window.addTaskDialog.find("#filename").val();if(window.newTaskData.filedesc=window.addTaskDialog.find("#filedesc").val(),window.newTaskData.format=window.addTaskDialog.find("#format").val(),!r||!window.newTaskData.filedesc)return void o.showFormError("Filename and file description cannot be empty!");window.newTaskData.filenamechecked&&r===window.newTaskData.filename?t():o.askAPI("validatefilename",{filename:r},["filename"],function(){window.newTaskData.filenamechecked=!0,t()});break;case"confirm":t()}},askAPI:function(a,t,e,n){o.apiPost(a,t).done(function(a){if(a.error)return void o.showFormError(a.error);for(var t=0;t<e.length;t++)window.newTaskData[e[t]]=a[e[t]];return n?n():void 0}).fail(function(){o.showFormError("Something weird happened. Please try again.")})},eventTask:function(t,e){t=a(t),t.is(".disabled")||(t.off().addClass("disabled"),o.apiPost("task/"+e,{id:o.getTaskIDFromDOMID(t.attr("id"))}).done(function(a){a.error&&window.alert(a.error),o.checkStatus()}))},setText:function(a,t){for(var e=0;e<a.length;e++)window.addTaskDialog.find("#"+a[e]).text(t[a[e]])},eventButton:function(t,e){return a(s[e+"button"]).attr("id",t+"-"+e+"button").off().click(function(){o.eventTask(this,e)})},appendButtons:function(t,e,n,s){e.append(a("<td />").attr("id",s+"-title").attr("width","30%"));var i=a("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(a("<span />").attr("id",s+"-statustext"));t.length&&i.append(t[0]);for(var o=1;o<t.length;o++)i.append(t[o]);e.append(i).removeClass(n[0]).addClass(n[1])},openTaskModal:function(){window.addTaskDialog.find("#dialog-spinner").hide(),window.addTaskDialog.find(".modal-body").html("<center>"+e+"</center>"),o.newTask(),window.addTaskDialog.modal(),window.addTaskDialog.on("shown.bs.modal",function(){window.addTaskDialog.find("#url").focus()})},apiPost:function(t,e){return e._csrf_token=i,a.post("api/"+t,e)}};a(document).ready(function(){o.init()})}(jQuery);