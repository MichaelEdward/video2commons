!function(t){"use strict";var e=window.i18n,a='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',s="rtl"===e["@dir"],n={abortbutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-remove"></span> '+Mustache.escape(e.abort)+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs flip pull-right"><span class="glyphicon glyphicon-trash"></span> '+Mustache.escape(e.remove)+"</button>",restartbutton:'<button type="button" class="btn btn-warning btn-xs flip pull-right"><span class="glyphicon glyphicon-repeat"></span> '+Mustache.escape(e.restart)+"</button>",loading:"<center>"+a+"&nbsp;&nbsp;"+Mustache.escape(e.loading)+"</center>",errorDisconnect:'<div class="alert alert-danger">'+Mustache.escape(e.errorDisconnect)+"</div>",yourTasks:"<h4>"+Mustache.escape(e.yourTasks)+'</h4><table id="tasktable" class="table"><tbody></tbody></table>',addTask:'<input class="btn btn-primary btn-success btn-md" type="button" accesskey="n" value="'+Mustache.escape(e.addTask)+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md flip pull-right disabled" id="ssubtn">'+Mustache.escape(e.createServerSide)+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>',prevbutton:'<span class="glyphicon glyphicon-chevron-'+(s?"right":"left")+'"></span> '+Mustache.escape(e.back),nextbutton:Mustache.escape(e.next)+' <span class="glyphicon glyphicon-chevron-'+(s?"left":"right")+'"></span>',confirmbutton:Mustache.escape(e.confirm)+' <span class="glyphicon glyphicon-ok"></span>'},r="";e.a=function(){return function(t,e){if("#"===t[0]){var a=t.indexOf("|");if(0>a){if(/^[a-z0-9\-]+$/i.test(t.slice(1)))return'<a id="'+t.slice(1)+'"></a>'}else if(/^[a-z0-9\-]+$/i.test(t.substring(1,a)))return'<a id="'+t.substring(1,a)+'">'+e(t.slice(a+1))+"</a>"}return"<a>"+e(t)+"</a>"}};var i,o,d=window.video2commons={init:function(){t("#content").html(n.loading),d.loadCsrf(),d.checkStatus()},loadCsrf:function(){t.get("api/csrf").done(function(t){r=t.csrf})},checkStatus:function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);var e="api/status";t.get(e).done(function(e){t("#tasktable").length||d.setupTables(),d.populateResults(e),window.lastStatusCheck=setTimeout(d.checkStatus,e.hasrunning?5e3:6e4)}).fail(function(){t("#content").html(n.errorDisconnect)})},setupTables:function(){t("#content").html(n.yourTasks);var e=t(n.addTask);t("#content").append(e),e.click(function(){d.addTask()});var a=t(n.requestServerSide);t("#content").append(a.hide())},setProgressBar:function(t,e){var a=t.find(".progress-bar");0>e?(a.addClass("progress-bar-striped active").addClass("active").text(""),e=100):a.removeClass("progress-bar-striped active").text(e+"%"),a.attr({"aria-valuenow":e,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+e+"%"})},getTaskIDFromDOMID:function(t){var e=/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(t);return e[1]},populateResults:function(a){var s=window.innerHeight+window.scrollY>=document.body.offsetHeight,r=t("#tasktable > tbody");t("#task-new").remove(),r.find("> tr").each(function(){var e=t(this),s=d.getTaskIDFromDOMID(e.attr("id"));a.ids.indexOf(s)<0&&e.remove()}),t.each(a.values,function(a,s){var i="task-"+s.id,o=t("#"+i),c=!1;if(o.length?o.attr("status")!==s.status&&(o.html(""),c=!0):(o=t("<tr />"),o.attr({id:i,status:s.status}),r.append(o),c=!0),c){switch(s.status){case"progress":o.append(t("<td />").attr("id",i+"-title").attr("width","30%")).append(t("<td />").attr("id",i+"-status").attr("width","40%").append(t("<span />").attr("id",i+"-statustext"))).append(t("<td />").attr("id",i+"-progress").attr("width","30%"));var l=d.eventButton(i,"abort");o.find("#"+i+"-status").append(l);var u=o.find("#"+i+"-progress").html(n.progressbar);d.setProgressBar(u,-1),o.removeClass("success danger");break;case"done":d.appendButtons([d.eventButton(i,"remove")],o,["danger","success"],i);break;case"fail":var f=d.eventButton(i,"remove"),p=d.eventButton(i,"restart").hide();d.appendButtons([f,p],o,["success","danger"],i);break;case"needssu":d.appendButtons([d.eventButton(i,"remove")],o,["success","danger"],i);break;case"abort":d.appendButtons([],o,["success","danger"],i)}o.attr("status",s.status)}o.find("#"+i+"-title").text(s.title);var h=function(t,e,a){var s=o.find("#"+i+"-statustext");if(e){var n=s.html(t).find("a").attr("href",e);a&&n.text(a)}else s.text(t)};"done"===s.status?h(Mustache.render("{{> taskDone}}",e,e),s.url,s.text):"needssu"===s.status?h(Mustache.render("{{> errorTooLarge}}",e,e),s.url):"fail"===s.status?(h(s.text),s.restartable?o.find("#"+i+"-restartbutton").show().off().click(function(){d.eventTask(this,"restart")}):o.find("#"+i+"-restartbutton").off().hide()):h(s.text),"progress"===s.status&&d.setProgressBar(o.find("#"+i+"-progress"),s.progress)}),a.ssulink?t("#ssubtn").removeClass("disabled").show().attr("href",a.ssulink):t("#ssubtn").addClass("disabled").hide(),s&&window.scrollTo(0,document.body.scrollHeight)},addTask:function(){i?d.openTaskModal():t.get("static/html/addTask.min.html").success(function(a){i=t("<div>").html(Mustache.render(a,e)),i.addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),t("body").append(i),i.find("#btn-prev").html(n.prevbutton),i.find("#btn-next").html(n.nextbutton),i.find(".modal-body").keypress(function(e){13!==(e.which||e.keyCode)||t(":focus").is("textarea")||(i.find(".modal-footer #btn-next").click(),e.preventDefault())}),d.openTaskModal()})},newTask:function(){o={step:"source",url:"",extractor:"",audio:!0,video:!0,subtitles:!0,filename:!0,filenamechecked:!1,formats:[],format:"",filedesc:""},d.setupAddTaskDialog()},setupAddTaskDialog:function(){switch(o.step){case"source":t.get("static/html/sourceForm.min.html").success(function(t){t=Mustache.render(t,e,e),i.find(".modal-body").html(t),i.find("a#vc").attr("href","//tools.wmflabs.org/videoconvert/"),i.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),i.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),i.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),i.find("#url").val(o.url).focus(),i.find("#video").prop("checked",o.video),i.find("#audio").prop("checked",o.audio),i.find("#subtitles").prop("checked",o.subtitles)});break;case"target":t.get("static/html/targetForm.min.html").success(function(a){a=Mustache.render(a,e),i.find(".modal-body").html(a),i.find("#filename").val(o.filename).focus(),t.each(o.formats,function(e,a){i.find("#format").append(t("<option></option>").text(a))}),i.find("#format").val(o.format),i.find("#filedesc").val(o.filedesc)});break;case"confirm":t.get("static/html/confirmForm.min.html").success(function(t){t=Mustache.render(t,e),i.find(".modal-body").html(t);var a=[];o.video&&a.push(e.video),o.audio&&a.push(e.audio),o.subtitles&&a.push(e.subtitles),i.find("#keep").text(a.join(", ")),d.setText(["url","extractor","filename","format"],o),i.find("#filedesc").val(o.filedesc),i.find("#btn-next").focus()})}d.reactivatePrevNextButtons()},showFormError:function(e){i.find(".modal-body #dialog-errorbox").length||i.find(".modal-body").append(t('<div class="alert alert-danger" id="dialog-errorbox"></div>')),i.find(".modal-body #dialog-errorbox").text("Error: "+e).show(),d.reactivatePrevNextButtons()},reactivatePrevNextButtons:function(){switch(i.find("#dialog-spinner").hide(),o.step){case"source":i.find("#btn-prev").addClass("disabled").off(),i.find("#btn-next").html(n.nextbutton),d.setPrevNextButton("next");break;case"target":d.setPrevNextButton("prev"),i.find("#btn-next").html(n.nextbutton),d.setPrevNextButton("next");break;case"confirm":d.setPrevNextButton("prev"),i.find("#btn-next").removeClass("disabled").html(n.confirmbutton).off().click(function(){d.disablePrevNext(!1),i.modal("hide"),t("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+a+"</td></tr>"),window.scrollTo(0,document.body.scrollHeight),d.apiPost("task/run",o).done(function(t){t.error&&window.alert(t.error),d.checkStatus()})})}},setPrevNextButton:function(t){i.find("#btn-"+t).removeClass("disabled").off().click(function(){d.disablePrevNext(!0),d.processInput(t)})},disablePrevNext:function(t){i.find(".modal-body #dialog-errorbox").hide(),i.find("#btn-prev").addClass("disabled").off(),i.find("#btn-next").addClass("disabled").off(),t&&i.find("#dialog-spinner").show()},processInput:function(t){var e=function(){var e={prev:-1,next:1}[t],a=["source","target","confirm"];o.step=a[a.indexOf(o.step)+e],d.setupAddTaskDialog()};switch(o.step){case"source":var a=i.find("#url").val(),s=i.find("#video").is(":checked"),n=i.find("#audio").is(":checked");if(o.subtitles=i.find("#subtitles").is(":checked"),!a)return void d.showFormError("URL cannot be empty!");var r=function(){o.formats.length&&s===o.video&&n===o.audio?e():d.askAPI("listformats",{video:s,audio:n},["video","audio","format","formats"],e)},c=function(){a!==o.url?(o.filenamechecked=!1,d.askAPI("extracturl",{url:a},["url","extractor","filedesc","filename"],r)):r()};c();break;case"target":var l=i.find("#filename").val();if(o.filedesc=i.find("#filedesc").val(),o.format=i.find("#format").val(),!l||!o.filedesc)return void d.showFormError("Filename and file description cannot be empty!");o.filenamechecked&&l===o.filename?e():d.askAPI("validatefilename",{filename:l},["filename"],function(){o.filenamechecked=!0,e()});break;case"confirm":e()}},askAPI:function(t,e,a,s){d.apiPost(t,e).done(function(t){if(t.error)return void d.showFormError(t.error);for(var e=0;e<a.length;e++)o[a[e]]=t[a[e]];return s?s():void 0}).fail(function(){d.showFormError("Something weird happened. Please try again.")})},eventTask:function(e,a){e=t(e),e.is(".disabled")||(e.off().addClass("disabled"),d.apiPost("task/"+a,{id:d.getTaskIDFromDOMID(e.attr("id"))}).done(function(t){t.error&&window.alert(t.error),d.checkStatus()}))},setText:function(t,e){for(var a=0;a<t.length;a++)i.find("#"+t[a]).text(e[t[a]])},eventButton:function(e,a){return t(n[a+"button"]).attr("id",e+"-"+a+"button").off().click(function(){d.eventTask(this,a)})},appendButtons:function(e,a,s,n){a.append(t("<td />").attr("id",n+"-title").attr("width","30%"));var r=t("<td />").attr("id",n+"-status").attr("width","70%").attr("colspan","2").append(t("<span />").attr("id",n+"-statustext"));e.length&&r.append(e[0]);for(var i=1;i<e.length;i++)r.append(e[i]);a.append(r).removeClass(s[0]).addClass(s[1])},openTaskModal:function(){i.find("#dialog-spinner").hide(),i.find(".modal-body").html("<center>"+a+"</center>"),d.newTask(),i.modal(),i.on("shown.bs.modal",function(){i.find("#url").focus()})},apiPost:function(e,a){return a._csrf_token=r,t.post("api/"+e,a)}};t(document).ready(function(){d.init()})}(jQuery);