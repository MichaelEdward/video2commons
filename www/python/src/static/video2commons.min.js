!function(a){"use strict";var t=window.video2commons={};t.init=function(){a("#content").html('<center><img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">&nbsp;&nbsp;LOADING...</center>'),this.checkStatus()},t.checkStatus=function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);var d="/video2commons/api/status";a.get(d).done(function(d){a("#tasktable").length||t.setupTables(),t.populateResults(d),window.lastStatusCheck=setTimeout(t.checkStatus,d.hasrunning?5e3:6e4)}).fail(function(){a("#content").html('<div class="alert alert-danger">Something went terribly wrong. Please refresh this page or contact [[:commons:User:Zhuyifei1999]].</div>')})},t.setupTables=function(){a("#content").html('<div class="container" id="content"><h4>Your tasks:</h4><table id="tasktable" class="table"><tbody></tbody></table></div>');var d=a('<input class="btn btn-primary btn-success btn-md" type="button" accesskey="n" value="Add task...">');a("#content").append(d),d.click(function(){t.addTask()});var i=a('<a class="btn btn-primary btn-success btn-md pull-right disabled" id="ssubtn">Create server-side upload ticket in one go (recommended)</a>');a("#content").append(i.hide())},t.setProgressBar=function(a,t){var d=a.find(".progress-bar");0>t?(d.addClass("progress-bar-striped active").addClass("active").text(""),t=100):d.removeClass("progress-bar-striped active").text(t+"%"),d.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},t.getTaskIDFromDOMID=function(a){var t=/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|removebutton|restartbutton))?$/.exec(a);return t[1]},t.populateResults=function(d){var i=a("#tasktable > tbody");a("#task-new").remove(),i.find("> tr").each(function(){var i=a(this),e=t.getTaskIDFromDOMID(i.attr("id"));d.ids.indexOf(e)<0&&i.remove()}),a.each(d.values,function(d,e){var s="task-"+e.id,o=a("#"+s),n=!1;o.length?o.attr("status")!==e.status&&(o.html(""),n=!0):(o=a("<tr />"),o.attr({id:s,status:e.status}),i.append(o),n=!0);var r,l='<button type="button" class="btn btn-danger btn-xs pull-right"><span class="glyphicon glyphicon-trash"></span> Remove</button>',c='<button type="button" class="btn btn-warning btn-xs pull-right"><span class="glyphicon glyphicon-repeat"></span> Restart</button>';if(n){switch(e.status){case"progress":o.append(a("<td />").attr("id",s+"-title").attr("width","30%")).append(a("<td />").attr("id",s+"-status").attr("width","40%").append(a("<span />").attr("id",s+"-statustext"))).append(a("<td />").attr("id",s+"-progress").attr("width","30%"));var w=o.find("#"+s+"-progress").html('<div class="progress"><div class="progress-bar" role="progressbar"></div></div>');t.setProgressBar(w,-1),o.removeClass("success danger");break;case"done":o.append(a("<td />").attr("id",s+"-title").attr("width","30%")),r=a(l).attr("id",s+"-removebutton").off().click(function(){a(this).addClass("disabled"),t.removeTask(t.getTaskIDFromDOMID(a(this).attr("id")))}),o.append(a("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(a("<span />").attr("id",s+"-statustext")).append(r)).removeClass("danger").addClass("success");break;case"fail":o.append(a("<td />").attr("id",s+"-title").attr("width","30%")),r=a(l).attr("id",s+"-removebutton").off().click(function(){a(this).addClass("disabled"),t.removeTask(t.getTaskIDFromDOMID(a(this).attr("id")))});var f=a(c).attr("id",s+"-restartbutton").hide();o.append(a("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(a("<span />").attr("id",s+"-statustext")).append(r).append(f)).removeClass("success").addClass("danger");break;case"needssu":o.append(a("<td />").attr("id",s+"-title").attr("width","30%")),r=a(l).attr("id",s+"-removebutton").off().click(function(){a(this).addClass("disabled"),t.removeTask(t.getTaskIDFromDOMID(a(this).attr("id")))});var p=a("<a>request a server-side upload</a>").attr("href",e.url);o.append(a("<td />").attr("id",s+"-status").attr("width","70%").attr("colspan","2").append(a("<span />").attr("id",s+"-statustext").append(p)).append(r)).removeClass("success").addClass("danger")}o.attr("status",e.status)}o.find("#"+s+"-title").text(e.title),"done"===e.status?o.find("#"+s+"-statustext").html("Your task is done. You may find your upload at <a></a>.").find("a").attr("href",e.url).text(e.text):"needssu"===e.status?o.find("#"+s+"-statustext").html("File too large to upload directly! You may want to <a>request a server-side upload</a>.").find("a").attr("href",e.url):"fail"===e.status?(o.find("#"+s+"-statustext").text(e.text),e.restartable?o.find("#"+s+"-restartbutton").show().off().click(function(){a(this).addClass("disabled"),t.restartTask(t.getTaskIDFromDOMID(a(this).attr("id")))}):o.find("#"+s+"-restartbutton").off().hide()):o.find("#"+s+"-statustext").text(e.text),"progress"===e.status&&t.setProgressBar(o.find("#"+s+"-progress"),e.progress)}),d.ssulink?a("#ssubtn").removeClass("disabled").show().attr("href",d.ssulink):a("#ssubtn").addClass("disabled").hide()},t.addTask=function(){window.addTaskDialog||(window.addTaskDialog=a("<div>").addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}).load("static/html/addTask.min.html"),a("body").append(window.addTaskDialog),window.addTaskDialog.find(".modal-body").keypress(function(t){13!==(t.which||t.keyCode)||a(":focus").is("textarea")||(window.addTaskDialog.find(".modal-footer #btn-next").click(),t.preventDefault())})),window.addTaskDialog.find("#dialog-spinner").hide(),window.addTaskDialog.find(".modal-body").html('<center><img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32"></center>'),this.newTask(),window.addTaskDialog.modal(),window.addTaskDialog.on("shown.bs.modal",function(){window.addTaskDialog.find("#url").focus()})},t.newTask=function(){var d="/video2commons/api/task/new";a.post(d).done(function(a){window.newTaskTempID=a.id,t.setupAddTaskDialog(a)}).fail(function(){window.addTaskDialog.html('<div class="alert alert-danger">Something went wrong. Please try again, refresh this page, or contact [[:commons:User:Zhuyifei1999]].</div>')})},t.setupAddTaskDialog=function(d){switch(window.addTaskDialog.find("#dialog-spinner").hide(),"error"!==d.step&&(window.addTaskStep=d.step),d.step){case"error":window.addTaskDialog.find(".modal-body #dialog-errorbox").length||window.addTaskDialog.find(".modal-body").append(a('<div class="alert alert-danger" id="dialog-errorbox"></div>')),window.addTaskDialog.find(".modal-body #dialog-errorbox").text("Error: "+d.error).show();break;case"source":window.addTaskDialog.find(".modal-body").load("static/html/sourceForm.min.html"),window.addTaskDialog.find("#url").val(d.url).focus(),window.addTaskDialog.find("#video").prop("checked",d.video),window.addTaskDialog.find("#audio").prop("checked",d.audio),window.addTaskDialog.find("#subtitles").prop("checked",d.subtitles);break;case"target":window.addTaskDialog.find(".modal-body").load("static/html/targetForm.min.html"),window.addTaskDialog.find("#filename").val(d.filename).focus(),a.each(d.formats,function(t,d){window.addTaskDialog.find("#format").append(a("<option></option>").text(d))}),window.addTaskDialog.find("#format").val(d.format),window.addTaskDialog.find("#filedesc").val(d.filedesc);break;case"confirm":window.addTaskDialog.find(".modal-body").load("static/html/confirmForm.min.html"),t.setText(["url","extractor","keep","filename","format"],d),window.addTaskDialog.find("#filedesc").val(d.filedesc),window.addTaskDialog.find("#btn-next").focus()}switch(window.addTaskStep){case"source":window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html('Next <span class="glyphicon glyphicon-chevron-right"></span>').off(),window.addTaskDialog.find("#btn-next").click(function(){t.disablePrevNext(),window.addTaskDialog.find("#dialog-spinner").show();var a={id:window.newTaskTempID,action:"next",step:window.addTaskStep,url:window.addTaskDialog.find("#url").val(),video:window.addTaskDialog.find("#video").is(":checked"),audio:window.addTaskDialog.find("#audio").is(":checked"),subtitles:window.addTaskDialog.find("#subtitles").is(":checked")};t.submitTask(a)});break;case"target":window.addTaskDialog.find("#btn-prev").removeClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html('Next <span class="glyphicon glyphicon-chevron-right"></span>').off(),t.addTargetDialog("prev"),t.addTargetDialog("next");break;case"confirm":window.addTaskDialog.find("#btn-prev").removeClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html('Confirm <span class="glyphicon glyphicon-ok"></span>').off(),window.addTaskDialog.find("#btn-prev").click(function(){t.disablePrevNext(),window.addTaskDialog.find("#dialog-spinner").show();var a={id:window.newTaskTempID,action:"prev",step:window.addTaskStep};t.submitTask(a)}),window.addTaskDialog.find("#btn-next").click(function(){t.disablePrevNext(),window.addTaskDialog.modal("hide"),a("#tasktable > tbody").append('<tr id="task-new"><td colspan="3"><img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32"></td></tr>');var d={id:window.newTaskTempID,action:"next",step:window.addTaskStep};a.post("/video2commons/api/task/submit",d).done(function(a){a.error&&window.alert(a.error),t.checkStatus()})})}},t.removeTask=function(a){t.eventTask(a,"remove")},t.restartTask=function(a){t.eventTask(a,"restart")},t.eventTask=function(d,i){a.post("/video2commons/api/task/"+i,{id:d}).done(function(a){a.error&&window.alert(a.error),t.checkStatus()})},t.setText=function(a,t){for(var d=0;d<a.length;d++)window.addTaskDialog.find("#"+a[d]).text(t[a[d]])},t.getPostData=function(a){return{id:window.newTaskTempID,action:a,step:window.addTaskStep,filename:window.addTaskDialog.find("#filename").val(),format:window.addTaskDialog.find("#format").val(),filedesc:window.addTaskDialog.find("#filedesc").val()}},t.submitTask=function(d){a.post("/video2commons/api/task/submit",d).done(function(a){a.error&&window.alert(a.error),t.setupAddTaskDialog(a)})},t.addTargetDialog=function(a){window.addTaskDialog.find("#btn-"+a).click(function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off(),window.addTaskDialog.find("#dialog-spinner").show(),this.submitTask(this.getPostData(a))})},t.disablePrevNext=function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off()},a(document).ready(function(){t.init()})}(jQuery);