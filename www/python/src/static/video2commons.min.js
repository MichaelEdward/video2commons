!function(a){"use strict";var t=window.labels,d='<img alt="File:Ajax-loader.gif" src="//upload.wikimedia.org/wikipedia/commons/d/de/Ajax-loader.gif" data-file-width="32" data-file-height="32" height="32" width="32">',e={abortbutton:'<button type="button" class="btn btn-danger btn-xs pull-right"><span class="glyphicon glyphicon-remove"></span> '+window.labels.abort+"</button>",removebutton:'<button type="button" class="btn btn-danger btn-xs pull-right"><span class="glyphicon glyphicon-trash"></span> '+window.labels.remove+"</button>",restartbutton:'<button type="button" class="btn btn-warning btn-xs pull-right"><span class="glyphicon glyphicon-repeat"></span> '+window.labels.restart+"</button>",loading:"<center>"+d+"&nbsp;&nbsp;"+window.labels.loading+"</center>",errorGeneric:'<div class="alert alert-danger">'+window.labels.errorGeneric+"</div>",yourTasks:'<div class="container" id="content"><h4>'+window.labels.yourTasks+'</h4><table id="tasktable" class="table"><tbody></tbody></table></div>',addTask:'<input class="btn btn-primary btn-success btn-md" type="button" accesskey="n" value="'+window.labels.addTask+'">',requestServerSide:'<a class="btn btn-primary btn-success btn-md pull-right disabled" id="ssubtn">'+window.labels.createServerSide+"</a>",progressbar:'<div class="progress"><div class="progress-bar" role="progressbar"></div></div>'},i=window.video2commons={};i.init=function(){a("#content").html(e.loading),i.checkStatus()},i.checkStatus=function(){window.lastStatusCheck&&clearTimeout(window.lastStatusCheck);var t="api/status";a.get(t).done(function(t){a("#tasktable").length||i.setupTables(),i.populateResults(t),window.lastStatusCheck=setTimeout(i.checkStatus,t.hasrunning?5e3:6e4)}).fail(function(){a("#content").html(e.errorGeneric)})},i.setupTables=function(){a("#content").html(e.yourTasks);var t=a(e.addTask);a("#content").append(t),t.click(function(){i.addTask()});var d=a(e.requestServerSide);a("#content").append(d.hide())},i.setProgressBar=function(a,t){var d=a.find(".progress-bar");0>t?(d.addClass("progress-bar-striped active").addClass("active").text(""),t=100):d.removeClass("progress-bar-striped active").text(t+"%"),d.attr({"aria-valuenow":t,"aria-valuemin":"0","aria-valuemax":"100",style:"width:"+t+"%"})},i.getTaskIDFromDOMID=function(a){var t=/^(?:task-)?(.+?)(?:-(?:title|statustext|progress|abortbutton|removebutton|restartbutton))?$/.exec(a);return t[1]},i.populateResults=function(d){var s=a("#tasktable > tbody");a("#task-new").remove(),s.find("> tr").each(function(){var t=a(this),e=i.getTaskIDFromDOMID(t.attr("id"));d.ids.indexOf(e)<0&&t.remove()}),a.each(d.values,function(d,n){var o="task-"+n.id,r=a("#"+o),l=!1;r.length?r.attr("status")!==n.status&&(r.html(""),l=!0):(r=a("<tr />"),r.attr({id:o,status:n.status}),s.append(r),l=!0);var c;if(l){switch(n.status){case"progress":r.append(a("<td />").attr("id",o+"-title").attr("width","30%")).append(a("<td />").attr("id",o+"-status").attr("width","40%").append(a("<span />").attr("id",o+"-statustext"))).append(a("<td />").attr("id",o+"-progress").attr("width","30%"));var w=a(e.abortbutton).attr("id",o+"-abortbutton");r.find("#"+o+"-status").append(w);var u=r.find("#"+o+"-progress").html(e.progressbar);i.setProgressBar(u,-1),r.removeClass("success danger");break;case"done":c=i.removebutton(this,o),i.appendButtons([c],r,["danger","success"],o);break;case"fail":c=i.removebutton(this,o);var f=a(e.restartbutton).attr("id",o+"-restartbutton").hide();i.appendButtons([c,f],r,["success","danger"],o);break;case"needssu":c=i.removebutton(this,o);var k=a(t.requestServerSide).attr("href",n.url);i.appendButtons([k,c],r,["success","danger"],o);break;case"abort":i.appendButtons([],r,["success","danger"],o)}r.attr("status",n.status)}r.find("#"+o+"-title").text(n.title),"done"===n.status?r.find("#"+o+"-statustext").html(t.taskDone).find("a").attr("href",n.url).text(n.text):"needssu"===n.status?r.find("#"+o+"-statustext").html(t.errorTooLarge).find("a").attr("href",n.url):"fail"===n.status?(r.find("#"+o+"-statustext").text(n.text),n.restartable?r.find("#"+o+"-restartbutton").show().off().click(function(){a(this).addClass("disabled"),i.restartTask(i.getTaskIDFromDOMID(a(this).attr("id")))}):r.find("#"+o+"-restartbutton").off().hide()):r.find("#"+o+"-statustext").text(n.text),"progress"===n.status&&(i.setProgressBar(r.find("#"+o+"-progress"),n.progress),r.find("#"+o+"-abortbutton").show().off().click(function(){a(this).addClass("disabled"),i.abortTask(i.getTaskIDFromDOMID(a(this).attr("id")))}))}),d.ssulink?a("#ssubtn").removeClass("disabled").show().attr("href",d.ssulink):a("#ssubtn").addClass("disabled").hide()},i.addTask=function(){window.addTaskDialog?i.openTaskModal():a.get("static/html/addTask.min.html").success(function(d){window.addTaskDialog=a("<div>").html(Mustache.render(d,t)),window.addTaskDialog.addClass("modal fade").attr({id:"addTaskDialog",role:"dialog"}),a("body").append(window.addTaskDialog),window.addTaskDialog.find(".modal-body").keypress(function(t){13!==(t.which||t.keyCode)||a(":focus").is("textarea")||(window.addTaskDialog.find(".modal-footer #btn-next").click(),t.preventDefault())}),i.openTaskModal()})},i.newTask=function(){var t="api/task/new";a.post(t).done(function(a){window.newTaskTempID=a.id,i.setupAddTaskDialog(a)}).fail(function(){window.addTaskDialog.html(e.errorGeneric)})},i.setupAddTaskDialog=function(e){switch(window.addTaskDialog.find("#dialog-spinner").hide(),"error"!==e.step&&(window.addTaskStep=e.step),e.step){case"error":window.addTaskDialog.find(".modal-body #dialog-errorbox").length||window.addTaskDialog.find(".modal-body").append(a('<div class="alert alert-danger" id="dialog-errorbox"></div>')),window.addTaskDialog.find(".modal-body #dialog-errorbox").text("Error: "+e.error).show();break;case"source":a.get("static/html/sourceForm.min.html").success(function(a){a=Mustache.render(a,t),window.addTaskDialog.find(".modal-body").html(a),window.addTaskDialog.find("a#vc").attr("href","//tools.wmflabs.org/videoconvert/"),window.addTaskDialog.find("a#fl").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Acceptable_licenses"),window.addTaskDialog.find("a#pd").attr("href","//commons.wikimedia.org/wiki/Commons:Licensing#Material_in_the_public_domain"),window.addTaskDialog.find("a#fu").attr("href","//commons.wikimedia.org/wiki/Commons:FU"),window.addTaskDialog.find("#url").val(e.url).focus(),window.addTaskDialog.find("#video").prop("checked",e.video),window.addTaskDialog.find("#audio").prop("checked",e.audio),window.addTaskDialog.find("#subtitles").prop("checked",e.subtitles)});break;case"target":a.get("static/html/targetForm.min.html").success(function(d){d=Mustache.render(d,t),window.addTaskDialog.find(".modal-body").html(d),window.addTaskDialog.find("#filename").val(e.filename).focus(),a.each(e.formats,function(t,d){window.addTaskDialog.find("#format").append(a("<option></option>").text(d))}),window.addTaskDialog.find("#format").val(e.format),window.addTaskDialog.find("#filedesc").val(e.filedesc)});break;case"confirm":a.get("static/html/confirmForm.min.html").success(function(a){a=Mustache.render(a,t),window.addTaskDialog.find(".modal-body").html(a),i.setText(["url","extractor","keep","filename","format"],e),window.addTaskDialog.find("#filedesc").val(e.filedesc),window.addTaskDialog.find("#btn-next").focus()})}switch(window.addTaskStep){case"source":window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html(t.next+' <span class="glyphicon glyphicon-chevron-right"></span>').off(),window.addTaskDialog.find("#btn-next").click(function(){i.disablePrevNext(),window.addTaskDialog.find("#dialog-spinner").show();var a={id:window.newTaskTempID,action:"next",step:window.addTaskStep,url:window.addTaskDialog.find("#url").val(),video:window.addTaskDialog.find("#video").is(":checked"),audio:window.addTaskDialog.find("#audio").is(":checked"),subtitles:window.addTaskDialog.find("#subtitles").is(":checked")};i.submitTask(a)});break;case"target":window.addTaskDialog.find("#btn-prev").removeClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html(t.next+' <span class="glyphicon glyphicon-chevron-right"></span>').off(),i.addTargetDialog("prev"),i.addTargetDialog("next");break;case"confirm":window.addTaskDialog.find("#btn-prev").removeClass("disabled").off(),window.addTaskDialog.find("#btn-next").removeClass("disabled").html(t.confirm+' <span class="glyphicon glyphicon-ok"></span>').off(),window.addTaskDialog.find("#btn-prev").click(function(){i.disablePrevNext(),window.addTaskDialog.find("#dialog-spinner").show();var a={id:window.newTaskTempID,action:"prev",step:window.addTaskStep};i.submitTask(a)}),window.addTaskDialog.find("#btn-next").click(function(){i.disablePrevNext(),window.addTaskDialog.modal("hide"),a("#tasktable > tbody").append('<tr id="task-new"><td colspan="3">'+d+"</td></tr>");var t={id:window.newTaskTempID,action:"next",step:window.addTaskStep};a.post("api/task/submit",t).done(function(a){a.error&&window.alert(a.error),i.checkStatus()})})}},i.abortTask=function(a){i.eventTask(a,"abort")},i.removeTask=function(a){i.eventTask(a,"remove")},i.restartTask=function(a){i.eventTask(a,"restart")},i.eventTask=function(t,d){a.post("api/task/"+d,{id:t}).done(function(a){a.error&&window.alert(a.error),i.checkStatus()})},i.setText=function(a,t){for(var d=0;d<a.length;d++)window.addTaskDialog.find("#"+a[d]).text(t[a[d]])},i.getPostData=function(a){return{id:window.newTaskTempID,action:a,step:window.addTaskStep,filename:window.addTaskDialog.find("#filename").val(),format:window.addTaskDialog.find("#format").val(),filedesc:window.addTaskDialog.find("#filedesc").val()}},i.submitTask=function(t){a.post("api/task/submit",t).done(function(a){a.error&&window.alert(a.error),i.setupAddTaskDialog(a)})},i.addTargetDialog=function(a){window.addTaskDialog.find("#btn-"+a).click(function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off(),window.addTaskDialog.find("#dialog-spinner").show(),i.submitTask(i.getPostData(a))})},i.disablePrevNext=function(){window.addTaskDialog.find(".modal-body #dialog-errorbox").hide(),window.addTaskDialog.find("#btn-prev").addClass("disabled").off(),window.addTaskDialog.find("#btn-next").addClass("disabled").off()},i.removeButtonClick=function(t){return function(){a(t).addClass("disabled"),i.removeTask(i.getTaskIDFromDOMID(a(t).attr("id")))}},i.removebutton=function(t,d){return a(e.removebutton).attr("id",d+"-removebutton").off().click(i.removeButtonClick(t))},i.appendButtons=function(t,d,e,i){d.append(a("<td />").attr("id",i+"-title").attr("width","30%"));var s=a("<td />").attr("id",i+"-status").attr("width","70%").attr("colspan","2").append(a("<span />").attr("id",i+"-statustext"));t.length&&s.append(t[0]);for(var n=1;n<t.length;n++)s.append(t[n]);d.append(s).removeClass(e[0]).addClass(e[1])},i.openTaskModal=function(){window.addTaskDialog.find("#dialog-spinner").hide(),window.addTaskDialog.find(".modal-body").html("<center>"+d+"</center>"),i.newTask(),window.addTaskDialog.modal(),window.addTaskDialog.on("shown.bs.modal",function(){window.addTaskDialog.find("#url").focus()})},a(document).ready(function(){i.init()})}(jQuery);